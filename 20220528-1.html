<!DOCTYPE html><html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width,initial-scale=1"> <meta name="author" content="Merijn Hendriks"> <title>Merijn Hendriks</title> <link rel="icon" type="image/x-icon" href="./assets/img/favicon.ico"> <link rel="stylesheet" type="text/css" href="./assets/css/bundle.css"> </head> <body class="container-fluid min-vh-100 d-flex flex-column"> <header class="p-5 blog-banner"> <div class="container-fluid py-5"> <h1 class="display-5 fw-bold"><a href="./index.html">Merijn Hendriks</a></h1> <p class="col-md-8 fs-4">Programmer, Creative, Nerd</p> </div> </header> <main class="row flex-grow-1"> <article class="col-md-8 p-5" id="blog-content"><h1>C89-OOP: Polymorphism</h1> <p>This chapter can be quite short because most of it already has been covered in the <code>C89-OOP: interface inheritance</code> article. The concept is the same; we use a VMT to store all references of virtual methods in there.</p> <h2>Virtual and override</h2> <p>There isn't much to say here for making virtual methods, as it's exactly the same as making an interface:</p> <pre class="language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">Foo_vmt</span> Foo_vmt<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">Foo</span> Foo<span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">Foo_vmt</span>
<span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>add<span class="token punctuation">)</span><span class="token punctuation">(</span>Foo<span class="token operator">*</span> self<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">Foo</span>
<span class="token punctuation">{</span>
    Foo_vmt<span class="token operator">*</span> vptr<span class="token punctuation">;</span>
    <span class="token keyword">int</span> x<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Foo_add</span><span class="token punctuation">(</span>Foo<span class="token operator">*</span> self<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token operator">++</span>self<span class="token operator">-&gt;</span>x<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> Foo_vmt foo_vmt <span class="token operator">=</span> <span class="token punctuation">{</span>
    Foo_add
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">Foo_ctor</span><span class="token punctuation">(</span>Foo<span class="token operator">*</span> self<span class="token punctuation">,</span> <span class="token keyword">int</span> x<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    self<span class="token operator">-&gt;</span>vptr <span class="token operator">=</span> <span class="token operator">&amp;</span>foo_vmt<span class="token punctuation">;</span>
    self<span class="token operator">-&gt;</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <p>Inherited classes can override the VMT members of <code>Foo</code> by providing their own implementation of the member. In order to access <code>Bar</code>'s fields inside the <code>Foo</code>'s VMT call, we need to downcast <code>Foo</code> to <code>Bar</code> first.</p> <pre class="language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">Bar</span> bar<span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">Bar</span>
<span class="token punctuation">{</span>
    Foo base<span class="token punctuation">;</span>
    Foo_vmt<span class="token operator">*</span> vptr<span class="token punctuation">;</span>
    <span class="token keyword">int</span> y<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Bar_add</span><span class="token punctuation">(</span>Foo<span class="token operator">*</span> self<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Bar<span class="token operator">*</span> bar <span class="token operator">=</span> <span class="token punctuation">(</span>Bar<span class="token operator">*</span><span class="token punctuation">)</span>self<span class="token punctuation">;</span>
    <span class="token operator">++</span>bar<span class="token operator">-&gt;</span>x<span class="token punctuation">;</span>
    <span class="token operator">++</span>bar<span class="token operator">-&gt;</span>y<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> Foo_vmt bar_vmt <span class="token operator">=</span> <span class="token punctuation">{</span>
    Bar_add
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">Bar_ctor</span><span class="token punctuation">(</span>Bar<span class="token operator">*</span> self<span class="token punctuation">,</span> <span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">Foo_ctor</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>self<span class="token operator">-&gt;</span>base<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    self<span class="token operator">-&gt;</span>base<span class="token punctuation">.</span>vptr <span class="token operator">=</span> <span class="token operator">&amp;</span>bar_vmt<span class="token punctuation">;</span>
    self<span class="token operator">-&gt;</span>y <span class="token operator">=</span> y<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <p>You can call the method like this:</p> <pre class="language-c"><code class="language-c">Bar bar<span class="token punctuation">;</span>
Foo<span class="token operator">*</span> foo<span class="token punctuation">;</span>

<span class="token function">Bar_ctor</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bar<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
foo <span class="token operator">=</span> <span class="token punctuation">(</span>Foo<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>bar<span class="token punctuation">;</span>
bar<span class="token punctuation">.</span>base<span class="token punctuation">.</span>vptr<span class="token operator">-&gt;</span><span class="token function">add</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <p>Note the cast we need to do in order to pass the correct type.</p> <h2>Abstract methods</h2> <p>To mark a member abstract, simply set the member to <code>0</code> so it will throw a runtime error whenever someone tries to execute it.</p> <pre class="language-c"><code class="language-c"><span class="token keyword">static</span> Foo_vmt foo_vmt <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token number">0</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <h2>Conclusion</h2> <p>You now know how to make a virtual method, how to override it, and how to make a method abstract!</p> <p>Not sure what I want to cover next, maybe how to emulate the <code>static</code> keyword behaviour from C#? Besides design patterns and a statagy for cleanup of classes in C, I can't think of anything else for the basics. Maybe I could cover macro (ab)use to emulate generics or how to emulate C# attributes / a simple type system.</p> <p>Who knows!</p> </article> </main> <aside class="col-md-4 p-5 blog-sidebar"> <h4>About</h4> <p>Hi! I'm a Dutch programmer with a love for hamburgers and sake nigiri. When I'm not programming all day, you can find me reading manga, playing S.T.A.L.K.E.R.: Call of Pripyat or D&amp;D5E / MTG with friends.</p> <h4>Links</h4> <ul> <li><a href="https://www.github.com/merijnhendriks">Github</a></li> <li><a href="mailto:merijn.d.hendriks@gmail.com">Email</a></li> </ul> </aside> </body> </html>