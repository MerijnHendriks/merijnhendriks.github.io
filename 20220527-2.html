<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width,initial-scale=1"> <meta name="author" content="No;Hurry"> <meta name="description" content="My personal blog."> <title>No;Hurry</title> <link rel="icon" type="image/x-icon" href="./assets/img/favicon.ico"> <link rel="stylesheet" type="text/css" href="./assets/css/bundle.css"> </head> <body>  <div class="container-fluid py-5"> <h1 class="fw-bold"><a href="./index.html">No;Hurry</a></h1> <p class="fs-4">Segfaulting life</p> </div>  <div class="container-fluid d-flex flex-column"> <div class="row flex-grow-1"> <main class="col-lg-9 p-5 offset-lg-3"> <article> <h1>C89-OOP: Casting</h1> <p>In most OOP languages it's possible to cast <code>base &lt;-&gt; derived</code>. A quick example of what I mean:</p> <pre class="language-csharp"><code class="language-csharp"><span class="token class-name">Bar</span> bar <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Foo</span> a <span class="token operator">=</span> <span class="token punctuation">(</span>Foo<span class="token punctuation">)</span>bar<span class="token punctuation">;</span>
<span class="token class-name">Bar</span> b <span class="token operator">=</span> <span class="token punctuation">(</span>Bar<span class="token punctuation">)</span>a<span class="token punctuation">;</span>
</code></pre> <p>In C89, the same is possible through pointer magic:</p> <pre class="language-c"><code class="language-c">Bar bar<span class="token punctuation">;</span>
Foo<span class="token operator">*</span> a<span class="token punctuation">;</span>
Bar b<span class="token punctuation">;</span>

<span class="token function">Bar_ctor</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bar<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
a <span class="token operator">=</span> <span class="token punctuation">(</span>Foo<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>bar<span class="token punctuation">)</span><span class="token punctuation">;</span>
b <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>Bar<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <p>Remember when I said it was important to have the <code>base</code> member first? The trick from above only works because of how memory alignment and padding rules work for structs;</p> <blockquote> <p>&quot;A pointer to a structure object, suitably converted, points to its initial member. There may be unnamed padding within a structure object, but not at its beginning&quot; -- WG14/N1256 Section 6.7.2.1.13</p> </blockquote> <p>This means that alignment is kept for the first member of a struct, which in return allows us to cast. Meaning it will cast correctly <code>Bar</code> -&gt; <code>Foo</code> -&gt; <code>Bar</code> (tested on Clang 7+ and GCC 4+).</p> <p>Sometimes it might works to cast a second or later member to the desired type and back, but this is not garuanteed to work by the standard. So far with Clang 14 I was able to do this on the stack but got segfaults on the heap.</p> <h2>Side effects</h2> <p>When downcasting, ensure that the class you're downcasting from is indeed of this type, otherwise you'll get random values from memory addresses and possibly a <code>segfault</code>.</p> <p>When downcasting from an upcast using pointer reference cast and then accessing a pointer member will also result into a <code>segfault</code>.</p> <pre class="language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">A</span> A<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">B</span> B<span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">A</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> val<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">B</span>
<span class="token punctuation">{</span>
    A base_a<span class="token punctuation">;</span>
    A<span class="token operator">*</span> virt_a<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">B_ctor</span><span class="token punctuation">(</span>B<span class="token operator">*</span> self<span class="token punctuation">,</span> <span class="token keyword">int</span> a<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    self<span class="token operator">-></span>base_a<span class="token punctuation">.</span>val <span class="token operator">=</span> a<span class="token punctuation">;</span>
    self<span class="token operator">-></span>virt_a <span class="token operator">=</span> <span class="token operator">&amp;</span>self<span class="token operator">-></span>baseA<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    B b<span class="token punctuation">;</span>
    A a<span class="token punctuation">;</span>

    <span class="token function">B_ctor</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    a <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>A<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    b <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>B<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <p>For example, accessing <code>b.virt_a-&gt;val</code> would result in a <code>segfault</code>, but accessing <code>b.base_a-&gt;val</code> would not.</p> <h2>Conclusion</h2> <p>You now know how to upcast and downcast structs in C89, as well as the possible side effects from doing this. Personally I would try to be explicit where possible and not make these kind of casts. In the next article I'll discuss inheritance through interfaces.</p> </article> </main> <aside class="col-lg-3 blog-sidebar"> <div class="p-5"> <h4>About</h4> <p>Hi! My name is Merijn Hendriks and I'm a Dutch programmer with a love for hamburgers and sake nigiri. When I'm not programming all day, you can find me reading manga, playing S.T.A.L.K.E.R.: Call of Pripyat or D&D5E / MTG with friends.</p> <h4>Links</h4> <ul> <li><a href="https://www.github.com/merijnhendriks">Github</a></li><li><a href="mailto:me@nohurry.moe">Email</a></li><li><a href="https://nohurry.moe/feed.rss">RSS</a></li> </ul> </div> </aside> </div> </div> </body> </html>