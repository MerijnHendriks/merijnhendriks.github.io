<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width,initial-scale=1"> <meta name="author" content="Merijn Hendriks"> <meta name="description" content="My personal blog."> <title>Merijn Hendriks</title> <link rel="icon" type="image/jpeg" href="./assets/img/favicon.jpg"> <link rel="stylesheet" type="text/css" href="./assets/css/bundle.css"> </head> <body> <header class="p-5 blog-banner"> <div class="container-fluid py-5"> <h1 class="fw-bold"><a href="./index.html">lp0 on fire</a></h1> <p class="fs-4">My personal blog</p> </div> </header> <div class="container-fluid d-flex flex-column"> <div class="row flex-grow-1"> <main class="col-lg-9 p-5"> <article> <h1>OS: Hardening ubuntu 22.04</h1> <p>Most of this is meant for a laptop that I take everywhere I go. The laptop:</p> <ul> <li>Might get stolen</li> <li>Sometimes has to connect to insecure open WIFI hotspots</li> <li>Sometimes has to load suspicious websites</li> </ul> <h2>Use a secure password</h2> <p>Use an unique password for everything. Most websites allow up to 16 characters, with special characters but not spaces and such. Try to find some nice creative ways around it, like so:</p> <pre class="language-txt"><code class="language-txt">Th1sIs$ecureRt!
</code></pre> <p>It's annoying, but it works really well.</p> <h2>Strip your system</h2> <p>Less is more! Remove everything you don't use/need on your main system, try to move useful but not often used applications (like recovery utilities) to a separate usb stick (for example a linux live usb).</p> <h2>Use alternatives</h2> <p>Replace pulseaudio with pipewire for better process isolation, EFISTUB boot instead of GRUB to reduce possible vulnerabilities during the boot process. There are probably more things like this that you could do, so check what's installed by default and if more secure alternatives exist that meet your requirements.</p> <h2>Protect your files</h2> <p>For important files, move them to an external hard drive and use Full Disk Encryption (FDE) to protect the data. Only bring the disk with you whenever you really need it.</p> <p>For the device, use FDE through LUKS. This can be done during the installation of Ubuntu of 22.04: Disk management &gt; select erasing the full disk &gt; select advanced options &gt; use LVM with the new installation &gt; Encrypt the new Ubuntu installation for security. Follow the prompts and you're done.</p> <h2>Updating</h2> <p>Ubuntu used APT for package management and updating your system. Ubuntu's APT repositories do not use HTTPS by default, making it vunerable to MITM attacks [1][2][3]. To add an additional layer of defence against these type of attacks, we can change the mirror urls to use HTTPS:</p> <pre class="language-sh"><code class="language-sh"><span class="token comment"># change this command to use your mirror</span>
<span class="token function">sed</span> --in-place --regexp-extended <span class="token string">'s http://(nl\.archive\.ubuntu\.com|security\.ubuntu\.com) https://nl.archive.ubuntu.com g'</span> /etc/apt/sources.list
</code></pre> <p>General good advice is to not install 3rd party PPA's, just stick what Ubuntu (and/or your company) provides.</p> <p>Another nice thing we can do is enable automatic updates to ensure the system is less likely to be the target of outdated apt index attacks. This can be done by running the following:</p> <pre class="language-sh"><code class="language-sh"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> <span class="token parameter variable">-y</span> --no-install-recommends unattended-upgrades
dpkg-reconfigure <span class="token parameter variable">--priority</span><span class="token operator">=</span>low unattended-upgrades
</code></pre> <h2>Firewall</h2> <p>Ubuntu's firewall is not enabled by default, nor does it contain any rules. So a good start is to enable it! I'm very strict with my firewall so I only allow outgoing traffic from specific ports, nothing else.</p> <pre class="language-sh"><code class="language-sh">ufw default deny incoming
ufw default deny outgoing
ufw allow out to any port <span class="token number">53</span>
ufw allow out to any port <span class="token number">443</span>
ufw <span class="token builtin class-name">enable</span>
</code></pre> <p>I don't use SSH so I disable it. I don't use HTTP because I re-routed Ubuntu's APT repository to use HTTPS instead.</p> <h2>Flatpak</h2> <p>Sandboxing provides another layer of defense to protect yourself against unintended access. With flatpak you can do this, and define what the package is (not) allowed to do through permissions. A good graphical management tool for flatpak permissions is <code>flatseal</code>.</p> <p>A nice example is <code>com.kingsoft.Office</code>. My office suite is really good, but it connects to the internet for templates and telemetry. I don't want this, so I disable network access for the package and monitor the network connections for a bit to check if doesn't escape the sandbox.</p> <p>This is especially nice for browsers. When an exploit escapes the browser, you can limit the amount of damage it can do.</p> <h2>Browser</h2> <p>As with everything else, disable what you don't need. This can be done in the most popular browsers using an extension called <code>UBlock Origin</code>. It can not only remove ads and trackers, it can also disable javascript and such. With another extension named <code>UMatrix</code>, you can select specific things you allow through.</p> <p>In addition, disable a lot of things in the browser. If you only use discord, netflix, google mail/docs and youtube in the browser you can disable things like cross-origin cookies and such.</p> <h2>SSH protection</h2> <p>Since SSH is a port that's often probed for, we need to make sure that attackers only have a limited ammount of attempts to try and blocking access. This can be done with <code>fail2ban</code>. In addition, use a key for authentication and change the port to make it harder to brute-force.</p> <h3>Change port</h3> <p>Allow the port in the firewall:</p> <pre class="language-sh"><code class="language-sh">ufw allow <span class="token number">2222</span>/tcp
</code></pre> <p>Set the port to use in SSH:</p> <pre class="language-sh"><code class="language-sh"><span class="token function">sudo</span> <span class="token function">nano</span> /etc/ssh/sshd_config
</code></pre> <pre class="language-txt"><code class="language-txt">Port 2222
</code></pre> <h3>Key login</h3> <p>Generating a key:</p> <pre class="language-sh"><code class="language-sh"><span class="token comment"># note: set passphrase when prompted to</span>
ssh-keygen <span class="token parameter variable">-t</span> rsa <span class="token parameter variable">-b</span> <span class="token number">4096</span>

<span class="token comment"># note: change &lt;user> to your username and &lt;server> to your server address</span>
ssh-copy-id <span class="token parameter variable">-i</span> ~/.ssh/id_rsa.pub user@server
</code></pre> <p>Enable ssh key authentication:</p> <pre class="language-sh"><code class="language-sh"><span class="token function">sudo</span> <span class="token function">nano</span> /etc/ssh/sshd_config
</code></pre> <pre class="language-txt"><code class="language-txt">PasswordAuthentication no
PubkeyAuthentication yes
</code></pre> <h3>Fail2Ban</h3> <p>To install:</p> <pre class="language-sh"><code class="language-sh"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> <span class="token parameter variable">-y</span> --no-install-recommends fail2ban
<span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> fail2ban.service
</code></pre> <p>For configuration:</p> <pre class="language-sh"><code class="language-sh"><span class="token function">sudo</span> <span class="token function">nano</span> /etc/fail2ban/jail.local
</code></pre> <pre class="language-txt"><code class="language-txt">[sshd]
enabled = true
port = ssh
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
findtime = 300
bantime = -1
ignoreip = 127.0.0.1
</code></pre> <h2>Conclusion</h2> <p>There are many more things that could be covered here like AppArmor, but then this article would become way too large hahaha. All steps combined are mostly an one-time setup and forget.</p> <h2>Appendix A: References</h2> <ul> <li>[1] <a href="https://justinsamuel.com/papers/package-managers-ccs2008.pdf">justinsamuel.com</a></li> <li>[2] <a href="https://justi.cz/security/2019/01/22/apt-rce.html">justi.cz</a></li> <li>[3] <a href="https://www.debian.org/security/2016/dsa-3733">debian.org</a></li> </ul> </article> </main> <aside class="col-lg-3 blog-sidebar"> <div class="p-5"> <h4>About</h4> <p>Hi! My name is Merijn Hendriks and I'm a Dutch programmer with a love for hamburgers and sake nigiri. When I'm not programming all day, you can find me reading manga, playing S.T.A.L.K.E.R.: Call of Pripyat or D&amp;D5E / MTG with friends.</p> <h4>Links</h4> <ul> <li><a href="https://www.github.com/merijnhendriks">Github</a></li><li><a href="mailto:me@nohurry.moe">Email</a></li><li><a href="https://nohurry.moe/feed.rss">RSS</a></li> </ul> </div> </aside> </div> </div> </body> </html>