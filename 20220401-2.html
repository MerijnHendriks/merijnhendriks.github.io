<!DOCTYPE html><html lang="en"><head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width,initial-scale=1"> <meta name="description" content="My personal blog"> <meta name="author" content="Merijn Hendriks"> <title>Merijn Hendriks</title> <link rel="icon" type="image/x-icon" href="./assets/img/favicon.ico"> <link rel="stylesheet" type="text/css" href="./assets/css/bundle.css"> </head> <body> <div class="container-fluid min-vh-100 d-flex flex-column"> <div class="p-5 blog-banner"> <div class="container-fluid py-5"> <h1 class="display-5 fw-bold"><a href="./index.html">Merijn Hendriks</a></h1> <p class="col-md-8 fs-4">Programmer, Creative, Nerd</p> </div> </div> <div class="row flex-grow-1"> <div class="col-md-8 p-5" id="blog-content"><h1 id="c89-oop-inheritance">C89-OOP: Inheritance</h1> <p>While C is not an object-oriented language, we can emulate the behaviour of object-oriented constructs inside the it. I don't think someone should try to emulate these structures in C outside of acedemic purposes (how do OOP languages work internally?), but who knows if someone finds some good use case out of this.</p> <p>For today I'll quickly glance over ways to implement inheritance, and how to solve the diamond problem. I'll assume you already have experience with an object-oriented language like Java / C#</p> <h2 id="class-anotonmy">Class anotonmy</h2> <pre class="language-java" tabindex="0"><code><span class="token keyword">class</span> <span class="token class-name">A</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> x<span class="token punctuation">;</span>

    <span class="token class-name">A</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> <span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">B</span> <span class="token keyword">extends</span> <span class="token class-name">A</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> y<span class="token punctuation">;</span>

    <span class="token class-name">B</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> <span class="token function">getY</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>y<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Program</span>
<span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">B</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">B</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">A</span> a <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">A</span><span class="token punctuation">)</span>b<span class="token punctuation">;</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> a<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
        <span class="token keyword">int</span> j <span class="token operator">=</span> b<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <p>Above we define the base class (<code>A</code>) and derived class (<code>B</code>). Each class has a constructor where we initialize our values. In case of the derived class, we call the constructor of the base class first. We also have a method for getting the value of the field each class has.</p> <p>You probably notice that the <code>this</code> keyword is used in the constructor and method of the class. This is a hidden pointer that contains a reference to the instance calling it.</p> <h2 id="simple-inheritance">Simple inheritance</h2> <pre class="language-c" tabindex="0"><code><span class="token comment">/* a.h */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">A_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">A_H</span></span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">A</span> A<span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">A</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> x<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">A_ctor</span><span class="token punctuation">(</span>A<span class="token operator">*</span> self<span class="token punctuation">,</span> <span class="token keyword">int</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">A_getX</span><span class="token punctuation">(</span>A<span class="token operator">*</span> self<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> <pre class="language-c" tabindex="0"><code><span class="token comment">/* a.c */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"a.h"</span><span class="token expression"><span class="token punctuation">;</span></span></span>

<span class="token keyword">void</span> <span class="token function">A_ctor</span><span class="token punctuation">(</span>A<span class="token operator">*</span> self<span class="token punctuation">,</span> <span class="token keyword">int</span> x<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    self<span class="token operator">-&gt;</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">A_getX</span><span class="token punctuation">(</span>A<span class="token operator">*</span> self<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> self<span class="token operator">-&gt;</span>x<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <pre class="language-c" tabindex="0"><code><span class="token comment">/* b.h */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">B_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">B_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"a.h"</span></span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">B</span> B<span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">B</span>
<span class="token punctuation">{</span>
    A base<span class="token punctuation">;</span>
    <span class="token keyword">int</span> y<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">B_ctor</span><span class="token punctuation">(</span>B<span class="token operator">*</span> self<span class="token punctuation">,</span> <span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">B_getY</span><span class="token punctuation">(</span>B<span class="token operator">*</span> self<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> <pre class="language-c" tabindex="0"><code><span class="token comment">/* b.c */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"b.h"</span></span>

<span class="token keyword">void</span> <span class="token function">B_ctor</span><span class="token punctuation">(</span>B<span class="token operator">*</span> self<span class="token punctuation">,</span> <span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">A_ctor</span><span class="token punctuation">(</span>self<span class="token operator">-&gt;</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
    self<span class="token operator">-&gt;</span>y <span class="token operator">=</span> y<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">B_getY</span><span class="token punctuation">(</span>B<span class="token operator">*</span> self<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> self<span class="token operator">-&gt;</span>y<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <pre class="language-c" tabindex="0"><code><span class="token comment">/* main.c */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"a.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"b.h"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    B b<span class="token punctuation">;</span>
    A a<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">int</span> j<span class="token punctuation">;</span>

    <span class="token function">B_ctor</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    a <span class="token operator">=</span> <span class="token punctuation">(</span>A<span class="token punctuation">)</span>b<span class="token punctuation">;</span>
    i <span class="token operator">=</span> <span class="token function">A_getX</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    j <span class="token operator">=</span> <span class="token function">B_getY</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> EXIT_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <p>The code above might look quite intimidating, but it's much simpler to understand when you split it up into multiple files.</p> <p>Since C doesn't have classes, we don't have type aliassing by default nor members with a hidden <code>this</code> pointer. There is no inheritance either, so we'll have to emulate this as well.</p> <p>The structs we define hold the fields and other important references (we'll get back to this in a later post later) of our class.</p> <p>We use type aliassing here so our struct is its own "type". Personally I always end up glance over the type aliassing in structs without noticing it so I explicitly use <code>typedef</code> first to make the code slightly easier to read; people know that type aliassing is used here.</p> <p>Because we don't call the functions from a class embedding them, we don't know which instance is calling them. This is why we have a <code>self</code> pointer parameter at the beginning of each function; to emulate the <code>this</code> keyword.</p> <p>Since C doesn't have constructors for structs build-in, we have to write one ourselves. <code>A_ctor()</code> and <code>B_ctor()</code> are just that. To avoid using dynamic memory allocation for instancing like we are forced to do in Java, I'm passing stack references instead.</p> <h2 id="why-does-casting-work">Why does casting work?</h2> <blockquote class="blockquote px-3"> <p>A pointer to a structure object, suitably converted, points to its initial member. There may be unnamed padding within a structure object, but not at its beginning</p> <p>-- WG14/N1256 Section 6.7.2.1.13</p> </blockquote> <p>This means that alignment is kept for the first member of a struct, which in return allows us to upcast.</p> <h2 id="solving-the-diamond-problem">Solving the diamond problem</h2> <p>…</p> <h3 id="interfaces">Interfaces</h3> <p>We can do this by using a very simple yet amazing trick: virtual tables!</p> <p>If you worked with most modern OOP languages before, you probably know what these are. They are a very simple solution to the problem: it doesn't exist if you never <em>have</em> to inherit multiple classes.</p> <pre class="language-java" tabindex="0"><code><span class="token keyword">interface</span> IA
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> <span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token keyword">implements</span> IA
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> x<span class="token punctuation">;</span>

    <span class="token class-name">A</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> <span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <p>To implement this in C, we only have to make a minor adjugement to <code>a.c</code>, <code>a.h</code> as well as make a header for <code>IA</code>:</p> <pre class="language-c" tabindex="0"><code><span class="token comment">/* ia.h */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">IA_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IA_H</span></span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">IA</span> IA<span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">IA</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span>getX<span class="token punctuation">)</span><span class="token punctuation">(</span>A<span class="token operator">*</span> self<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> <pre class="language-c" tabindex="0"><code><span class="token comment">/* a.h */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">A_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">A_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"ia.h"</span></span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">A</span> A<span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">A</span>
<span class="token punctuation">{</span>
    IA<span class="token operator">*</span> ia<span class="token punctuation">;</span>
    <span class="token keyword">int</span> x<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">A_ctor</span><span class="token punctuation">(</span>A<span class="token operator">*</span> self<span class="token punctuation">,</span> <span class="token keyword">int</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">A_getX</span><span class="token punctuation">(</span>A<span class="token operator">*</span> self<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> <pre class="language-c" tabindex="0"><code><span class="token comment">/* a.c */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"a.h"</span><span class="token expression"><span class="token punctuation">;</span></span></span>

<span class="token keyword">static</span> IA ia <span class="token operator">=</span> <span class="token punctuation">{</span>
    A_getX
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">A_ctor</span><span class="token punctuation">(</span>A<span class="token operator">*</span> self<span class="token punctuation">,</span> <span class="token keyword">int</span> x<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    self<span class="token operator">-&gt;</span>ia <span class="token operator">=</span> ia<span class="token punctuation">;</span>
    self<span class="token operator">-&gt;</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">A_getX</span><span class="token punctuation">(</span>A<span class="token operator">*</span> self<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> self<span class="token operator">-&gt;</span>x<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <p>I create one instance of <code>IA</code> in <code>a.c</code> so all instances of <code>A</code> will be pointing to the same reference of <code>IA</code>, which saves memory and makes the implementation a bit cleaner overall.</p> <h3 id="virtual-inheritance">Virtual inheritance</h3> <p>…todo!</p></div> <div class="col-md-4 p-5 blog-sidebar"> <h4>About</h4> <p>Hi! I'm a Dutch software architect. When I'm not programming all day, you can find me playing D&amp;D5E / MTG / video games with friends, reading manga / watching anime, or daydreaming. Love sushi, salmon, researching, making things work and cute things.</p> <h4>Links</h4> <ul> <li><a href="https://www.github.com/merijnhendriks">Github</a></li> <li><a href="mailto:merijn.d.hendriks@gmail.com">Email</a></li> </ul> </div> </div> </div> </body></html>